{% extends 'layout.html' %}
{% block content %}
<form method="post" enctype="multipart/form-data" class="mb-4">
    <div class="input-group">
        <input type="file" name="audio" accept="audio/*" class="form-control" id="audioFile" required>
        <button class="btn btn-primary" type="submit">Separar y Transcribir</button>
    </div>
</form>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if processed_songs %}
    <hr class="my-4">
    <h2 class="mb-3">Canciones Procesadas</h2>
    {% for song in processed_songs %}
        <div class="card mb-4">
            <h5 class="card-header">{{ song.name }}</h5>
            <div class="card-body">
                <div class="row">
                    {% for stem in song.stems %}
                    <div class="col-md-6 mb-3">
                        <h6 class="card-title">{{ stem.name }}</h6>
                        <audio controls class="w-100" preload="metadata">
                            <source src="{{ stem.url }}" type="audio/wav">
                        </audio>
                        <a href="{{ stem.url }}" download class="btn btn-sm btn-outline-success mt-2">Descargar Audio</a>
                    </div>
                    {% endfor %}
                </div>

                {% if song.midi_url %}
                <hr>
                <h6 class="card-title">Transcripción Interactiva</h6>
                <p>Visualiza la partitura generada a partir del archivo MIDI.</p>

                <div class="d-flex align-items-center gap-2 mt-2">
                    <a href="{{ song.midi_url }}" download class="btn btn-info">Descargar MIDI</a>
                    
                    <button class="btn btn-success play-score-btn" 
                            data-song-name="{{ song.name }}" 
                            data-midi-url="{{ song.midi_url }}">
                        ▶️ Ver Partitura
                    </button>
                    <button class="btn btn-danger stop-score-btn" data-song-name="{{ song.name }}">
                        ⏹️ Ocultar
                    </button>
                </div>

                <div id="score-{{ song.name }}" class="mt-3" style="background: white; padding: 10px; border-radius: 5px; overflow-x: auto; min-height: 50px;"></div>
                {% endif %}
            </div>
        </div>
    {% endfor %}
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    const OSMD = opensheetmusicdisplay.OpenSheetMusicDisplay;
    const songStates = {}; 

    async function displayScore(button) {
        const songName = button.dataset.songName;
        const scoreContainer = document.getElementById(`score-${songName}`);
        
        if (songStates[songName] && songStates[songName].isRendered) {
            scoreContainer.innerHTML = '';
            songStates[songName].isRendered = false;
            button.innerText = '▶️ Ver Partitura';
            return;
        }

        button.disabled = true;
        button.innerText = 'Cargando Partitura...';
        scoreContainer.innerHTML = '<p>Generando partitura...</p>';

        try {
            // ¡Llamamos a la nueva API!
            const response = await fetch(`/api/musicxml/${songName}`);
            if (!response.ok) throw new Error(`El servidor respondió con estado ${response.status}`);
            
            // Obtenemos la respuesta como texto (que será el XML)
            const musicXmlString = await response.text();

            const osmd = new OSMD(scoreContainer, { autoResize: true, drawTitle: false });

            // Cargamos el string de MusicXML y renderizamos
            await osmd.load(musicXmlString);
            osmd.render();
            
            console.log(`✅ Partitura para "${songName}" renderizada con éxito.`);
            songStates[songName] = { osmd: osmd, isRendered: true };

        } catch (error) {
            console.error(`Error al renderizar con OSMD para "${songName}":`, error);
            scoreContainer.innerHTML = `<p class="text-danger">No se pudo generar la partitura. Error: ${error.message}</p>`;
        } finally {
            button.disabled = false;
            button.innerText = 'Ocultar Partitura';
        }
    }
    
    // Usamos delegación de eventos para los botones
    document.body.addEventListener('click', (event) => {
        if (event.target.matches('.play-score-btn')) {
            displayScore(event.target);
        }
        
        if (event.target.matches('.stop-score-btn')) {
            const songName = event.target.dataset.songName;
            const scoreContainer = document.getElementById(`score-${songName}`);
            if(scoreContainer) scoreContainer.innerHTML = '';
            
            if(songStates[songName]) songStates[songName].isRendered = false;
            
            const playBtn = event.target.closest('.d-flex').querySelector('.play-score-btn');
            if (playBtn) playBtn.innerText = '▶️ Ver Partitura';
        }
    });
});
</script>
{% endblock %}