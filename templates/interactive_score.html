{% extends "layout.html" %}

{% block title %}Partitura Interactiva - {{ song_name }} - {{ instrument }}{% endblock %}

{% block head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<script src="/static/js/vexflow.js"></script>
<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        overflow: hidden;
    }
    .header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        text-align: center;
    }
    .score-container {
        padding: 30px;
        background: #f8f9fa;
    }
    .controls {
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        margin: 0 8px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .progress-container {
        margin: 20px 0;
        padding: 0 20px;
    }
    .progress {
        width: 100%;
        height: 25px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(45deg, #28a745, #20c997);
        width: 0%;
        transition: width 0.1s ease;
        border-radius: 15px;
    }
    .time-display {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin: 15px 0;
        text-align: center;
    }
    .note-info {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .note-highlight {
        fill: #ff6b6b !important;
        stroke: #ff4757 !important;
        stroke-width: 3 !important;
        filter: drop-shadow(0 0 5px rgba(255, 107, 107, 0.5));
    }
    .score-display {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-height: 200px;
    }
    .back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255,255,255,0.9);
        color: #333;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #ffa500;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<button class="back-btn" onclick="window.history.back()">‚Üê Volver</button>

<div class="container">
    <div class="header">
        <h1>üéº {{ song_name }}</h1>
        <h2>Instrumento: {{ instrument.title() }}</h2>
    </div>
    
    <div class="score-container">
        <div class="controls">
            <button class="btn" id="playBtn">‚ñ∂Ô∏è Reproducir</button>
            <button class="btn" id="pauseBtn" disabled>‚è∏Ô∏è Pausar</button>
            <button class="btn" id="stopBtn" disabled>‚èπÔ∏è Detener</button>
            <button class="btn" id="resetBtn">üîÑ Reiniciar</button>
        </div>
        
        <div class="progress-container">
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="time-display" id="timeDisplay">Tiempo: 0:00 / 0:00</div>
        </div>
        
        <!-- Audio element para reproducci√≥n real -->
        <audio id="audioPlayer" preload="auto" style="display: none;">
            <source id="audioSource" type="audio/wav">
            Tu navegador no soporta audio HTML5.
        </audio>
        
        <div class="score-display" id="score">
            <h3>üéº Partitura Musical</h3>
            <div id="scoreContainer">
                <p>Cargando partitura...</p>
            </div>
        </div>
        
        <div class="note-info" id="noteInfo">
            <h3>üìù Informaci√≥n de la partitura</h3>
            <p>Cargando datos...</p>
        </div>
    </div>
</div>

<script>
    window.onload = function() {
        // Cargar datos de la partitura
        fetch('/api/score/{{ song_name }}/{{ instrument }}/render')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('noteInfo').innerHTML = 
                        '<h3>‚ùå Error</h3><p>' + data.error + '</p>';
                    return;
                }
                
                const notesData = data.notes;
                const totalDuration = data.total_duration;
                const audioFile = data.audio_file;
                
                // Guardar datos de notas para sincronizaci√≥n con partitura
                currentNotesData = notesData;
                
                // Configurar archivo de audio
                document.getElementById('audioSource').src = audioFile;
                        const audioPlayer = document.getElementById('audioPlayer');
        globalAudioPlayer = audioPlayer; // Guardar referencia global para sincronizaci√≥n
        audioPlayer.load();
                
                // Mostrar informaci√≥n
                document.getElementById('noteInfo').innerHTML = `
                    <h3>üìù Informaci√≥n de la partitura</h3>
                    <p><strong>Total de notas:</strong> ${notesData.length}</p>
                    <p><strong>Duraci√≥n total (MIDI):</strong> ${formatTime(totalDuration)}</p>
                    <p><strong>Instrumento:</strong> {{ instrument.title() }}</p>
                    <p><strong>Archivo de audio:</strong> ${audioFile}</p>
                `;
                
                // Esperar a que el audio se cargue para obtener duraci√≥n real
                audioPlayer.addEventListener('loadedmetadata', () => {
                    const realDuration = audioPlayer.duration;
                    console.log('Duraci√≥n real del audio:', realDuration);
                    
                    // Actualizar informaci√≥n con duraci√≥n real
                    document.getElementById('noteInfo').innerHTML = `
                        <h3>üìù Informaci√≥n de la partitura</h3>
                        <p><strong>Total de notas:</strong> ${notesData.length}</p>
                        <p><strong>Duraci√≥n MIDI:</strong> ${formatTime(totalDuration)}</p>
                        <p><strong>Duraci√≥n real:</strong> ${formatTime(realDuration)}</p>
                        <p><strong>Instrumento:</strong> {{ instrument.title() }}</p>
                    `;
                    
                    // Inicializar controles con duraci√≥n real
                    initPlaybackControls(notesData, realDuration, audioPlayer);
                });
                
                // Cargar partitura desde MuseScore
                console.log('Cargando partitura generada por MuseScore...');
                loadScoreImage('{{ song_name }}', '{{ instrument }}');
            })
            .catch(error => {
                console.error('Error cargando datos:', error);
                document.getElementById('noteInfo').innerHTML = 
                    '<h3>‚ùå Error</h3><p>Error al cargar los datos de la partitura</p>';
            });
    };
    
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    function initPlaybackControls(notesData, totalDuration, audioPlayer) {
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');
        
        let playbackInterval;
        
        // Inicializar display de tiempo
        timeDisplay.textContent = `Tiempo: 0:00 / ${formatTime(totalDuration)}`;
        
        playBtn.addEventListener('click', () => {
            audioPlayer.play().then(() => {
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                
                // Sincronizar progreso con audio real
                playbackInterval = setInterval(() => {
                    const currentTime = audioPlayer.currentTime;
                    const progress = (currentTime / totalDuration) * 100;
                    progressBar.style.width = `${Math.min(progress, 100)}%`;
                    timeDisplay.textContent = `Tiempo: ${formatTime(currentTime)} / ${formatTime(totalDuration)}`;
                    
                    // Sincronizar partitura con audio
                    syncSheetMusicWithAudio(currentTime);
                }, 100);
            }).catch(error => {
                console.error('Error reproduciendo audio:', error);
                alert('Error al reproducir el audio. Verifica que el archivo existe.');
            });
        });
        
        pauseBtn.addEventListener('click', () => {
            audioPlayer.pause();
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            clearInterval(playbackInterval);
            clearNoteHighlights();
        });
        
        stopBtn.addEventListener('click', () => {
            stopPlayback();
        });
        
        resetBtn.addEventListener('click', () => {
            stopPlayback();
            audioPlayer.currentTime = 0;
            progressBar.style.width = '0%';
            timeDisplay.textContent = `Tiempo: 0:00 / ${formatTime(totalDuration)}`;
            clearNoteHighlights();
            // Reiniciar cursor de partitura
            if (currentOSMD && currentOSMD.cursor) {
                currentOSMD.cursor.reset();
                currentOSMD.render();
            }
        });
        
        // Event listeners del audio
        audioPlayer.addEventListener('ended', () => {
            stopPlayback();
        });
        
        audioPlayer.addEventListener('error', (e) => {
            console.error('Error en el audio:', e);
            alert('Error cargando el archivo de audio');
            stopPlayback();
        });
        
        function stopPlayback() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            clearInterval(playbackInterval);
            clearNoteHighlights();
            // Reiniciar cursor de partitura
            if (currentOSMD && currentOSMD.cursor) {
                currentOSMD.cursor.reset();
                currentOSMD.render();
            }
        }
    }
    
        // Sincronizaci√≥n de partitura con audio
    function syncSheetMusicWithAudio(currentTime) {
        const enableSyncCheckbox = document.getElementById('enableSync');
        if (!enableSyncCheckbox || !enableSyncCheckbox.checked) {
            return;
        }
        
        if (!currentOSMD || !currentOSMD.cursor || !currentOSMD.cursor.Iterator) {
            return;
        }
        
        try {
            if (!window.osmdNoteTimings || window.osmdNoteTimings.length === 0) {
                extractNoteTimingsFromOSMD();
                return;
            }
            
            const currentNoteData = findCurrentNoteByTime(currentTime, window.osmdNoteTimings);
            
            if (currentNoteData) {
                moveOSMDCursorToTime(currentNoteData.osmdTime);
                highlightNoteAtTime(currentNoteData);
            }
            
        } catch (error) {
            // Solo log de errores cr√≠ticos
            console.error('Error en sincronizaci√≥n:', error.message);
        }
    }
    
    // Extraer tiempos de notas de OSMD
    function extractNoteTimingsFromOSMD() {
        if (!currentOSMD || !currentOSMD.cursor) return;
        
        const allNotes = [];
        const iterator = currentOSMD.cursor.Iterator;
        
        // Obtener BPM de la partitura o usar 120 por defecto
        let bpm = 120;
        try {
            const tempoMarking = currentOSMD.sheet.sourceMeasures[0]?.tempoInBPM;
            if (tempoMarking && tempoMarking > 60 && tempoMarking < 200) {
                bpm = tempoMarking;
            }
        } catch (e) {
            // Usar BPM por defecto si no se puede extraer
            bpm = 120;
        }
        
        currentOSMD.cursor.reset();
        
        // Factor de escala para sincronizar con audio real
        const audioPlayer = globalAudioPlayer;
        const totalAudioDuration = audioPlayer ? audioPlayer.duration : 200;
        
        while (!iterator.EndReached) {
            const voices = iterator.CurrentVoiceEntries;
            
            for (let i = 0; i < voices.length; i++) {
                const voice = voices[i];
                const notes = voice.Notes;
                
                for (let j = 0; j < notes.length; j++) {
                    const note = notes[j];
                    
                    if (note != null && note.halfTone != 0 && !note.isRest()) {
                        const osmdTime = iterator.currentTimeStamp.RealValue;
                        
                        // Mejorar conversi√≥n de tiempo OSMD a tiempo real
                        // OSMD usa quarter notes como unidad base
                        const quarterNoteDuration = 60 / bpm; // duraci√≥n de una negra en segundos
                        const realTime = osmdTime * quarterNoteDuration;
                        
                        allNotes.push({
                            note: note.halfTone,
                            osmdTime: osmdTime,
                            realTime: realTime,
                            noteObj: note,
                            voice: voice,
                            measure: iterator.CurrentMeasureIndex || 0,
                            frequency: note.frequency || 440
                        });
                    }
                }
            }
            
            iterator.moveToNext();
        }
        
        // Escalar tiempos para que coincidan con la duraci√≥n real del audio
        if (allNotes.length > 0 && totalAudioDuration > 0) {
            const maxMidiTime = Math.max(...allNotes.map(n => n.realTime));
            const scaleFactor = totalAudioDuration / maxMidiTime;
            
            allNotes.forEach(note => {
                note.realTime *= scaleFactor;
            });
        }
        
        window.osmdNoteTimings = allNotes.sort((a, b) => a.realTime - b.realTime);
        currentOSMD.cursor.reset();
    }
    
    // Buscar nota actual por tiempo de audio
    function findCurrentNoteByTime(audioTime, noteTimings) {
        if (!noteTimings || noteTimings.length === 0) return null;
        
        // Buscar la nota que corresponde al tiempo de audio actual
        for (let i = 0; i < noteTimings.length; i++) {
            const note = noteTimings[i];
            const nextNote = noteTimings[i + 1];
            
            const noteStart = note.realTime;
            const noteEnd = nextNote ? nextNote.realTime : audioTime + 1;
            
            if (audioTime >= noteStart && audioTime < noteEnd) {
                return note;
            }
        }
        
        return null;
    }
    
    // Mover cursor OSMD a tiempo espec√≠fico
    function moveOSMDCursorToTime(targetOsmdTime) {
        if (!currentOSMD || !currentOSMD.cursor) return;
        
        const iterator = currentOSMD.cursor.Iterator;
        const currentPos = iterator.currentTimeStamp ? iterator.currentTimeStamp.RealValue : 0;
        
        if (Math.abs(currentPos - targetOsmdTime) < 0.01) return;
        
        currentOSMD.cursor.reset();
        
        let steps = 0;
        while (!iterator.EndReached && 
               iterator.currentTimeStamp.RealValue < targetOsmdTime && 
               steps < 500) {
            iterator.moveToNext();
            steps++;
        }
        
        currentOSMD.cursor.update();
        currentOSMD.cursor.show();
        currentOSMD.render();
    }
    
    // Resaltar nota espec√≠fica
    function highlightNoteAtTime(noteData) {
        if (!currentOSMD || !currentOSMD.cursor) return;
        
        // Limpiar highlights anteriores
        clearNoteHighlights();
        
        try {
            // M√©todo 1: Usar GNotesUnderCursor() - m√°s preciso
            const graphicalNotes = currentOSMD.cursor.GNotesUnderCursor();
            if (graphicalNotes && graphicalNotes.length > 0) {
                let highlightedCount = 0;
                
                graphicalNotes.forEach(gNote => {
                    if (gNote && gNote.getSVGGElement) {
                        const svgElement = gNote.getSVGGElement();
                        if (svgElement) {
                            // Aplicar estilo de resaltado m√°s visible
                            svgElement.style.fill = '#ff4444';
                            svgElement.style.stroke = '#ff0000';
                            svgElement.style.strokeWidth = '2px';
                            svgElement.style.filter = 'drop-shadow(0 0 6px #ff4444) brightness(1.2)';
                            svgElement.classList.add('note-highlight-sync');
                            
                            highlightedCount++;
                            
                            // Limpiar resaltado despu√©s de un tiempo
                            setTimeout(() => {
                                if (svgElement.classList.contains('note-highlight-sync')) {
                                    svgElement.style.fill = '';
                                    svgElement.style.stroke = '';
                                    svgElement.style.strokeWidth = '';
                                    svgElement.style.filter = '';
                                    svgElement.classList.remove('note-highlight-sync');
                                }
                            }, 600);
                        }
                    }
                });
                
                if (highlightedCount > 0) {
                    return; // √âxito con API OSMD
                }
            }
            
            // M√©todo 2: Fallback - resaltar usando cursor visible
            if (currentOSMD.cursor && currentOSMD.cursor.show) {
                currentOSMD.cursor.show();
                
                // Buscar y resaltar elementos SVG del cursor
                const cursorElements = document.querySelectorAll('.osmdCursor, .cursor');
                cursorElements.forEach(cursor => {
                    cursor.style.opacity = '1';
                    cursor.style.fill = '#ff4444';
                    cursor.style.stroke = '#ff0000';
                });
                
                // Ocultar cursor despu√©s de un tiempo
                setTimeout(() => {
                    cursorElements.forEach(cursor => {
                        cursor.style.opacity = '';
                        cursor.style.fill = '';
                        cursor.style.stroke = '';
                    });
                }, 600);
            }
            
        } catch (error) {
            console.error('Error en resaltado OSMD:', error.message);
            
            // M√©todo 3: Fallback SVG gen√©rico
            const timeProgressRatio = noteData.realTime / (globalAudioPlayer?.duration || 200);
            highlightCurrentNoteInSVGByTime(noteData, timeProgressRatio);
        }
    }
    
    // Funci√≥n auxiliar para cargar datos MIDI adicionales si es necesario
    function loadNotesDataForSync() {
        const songName = '{{ song_name }}';
        const instrument = '{{ instrument }}';
        const notesEndpoint = `/api/score/${songName}/${instrument}/render`;
        
        fetch(notesEndpoint)
            .then(response => response.ok ? response.json() : Promise.reject(`HTTP ${response.status}`))
            .then(data => {
                if (data.notes && Array.isArray(data.notes)) {
                    currentNotesData = data.notes;
                }
            })
            .catch(error => {
                console.error('Error cargando datos MIDI:', error);
            });
    }
    
    // Funci√≥n mejorada de resaltado SVG con detecci√≥n inteligente de notas
    function highlightCurrentNoteInSVGByTime(currentNote, timeProgress) {
        clearNoteHighlights();
        
        const containers = ['osmdContainer', 'osmdContainerDynamic'];
        let totalNotesHighlighted = 0;
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            
            if (container) {
                const svgElements = container.querySelectorAll('svg');
                
                svgElements.forEach((svg, svgIndex) => {
                    const noteHeads = svg.querySelectorAll('ellipse[fill="#000000"], ellipse[fill="black"], circle[fill="#000000"], circle[fill="black"]');
                    const paths = svg.querySelectorAll('path[fill="#000000"], path[fill="black"]');
                    const allNoteElements = [...noteHeads, ...paths];
                    
                    if (allNoteElements.length > 0) {
                        // Filtrar elementos que parecen notas v√°lidas
                        const likelyNotes = allNoteElements.filter(el => {
                            try {
                                const bbox = el.getBBox ? el.getBBox() : { width: 10, height: 10 };
                                return bbox.width > 2 && bbox.width < 50 && bbox.height > 2 && bbox.height < 50;
                            } catch (e) {
                                return true; // Asumir v√°lido si no se puede verificar
                            }
                        });
                        
                        if (likelyNotes.length > 0) {
                            // Calcular qu√© nota(s) resaltar basado en el progreso temporal
                            const notesPerSection = Math.max(1, Math.floor(likelyNotes.length / 20));
                            const sectionIndex = Math.floor(timeProgress * 20);
                            const startIndex = Math.min(sectionIndex * notesPerSection, likelyNotes.length - notesPerSection);
                            const endIndex = Math.min(startIndex + notesPerSection, likelyNotes.length);
                            
                            // Resaltar grupo de notas con estilo mejorado
                            for (let i = startIndex; i < endIndex; i++) {
                                const note = likelyNotes[i];
                                note.style.fill = '#ff4444';
                                note.style.stroke = '#ff0000';
                                note.style.strokeWidth = '2px';
                                note.style.filter = 'drop-shadow(0 0 6px #ff4444) brightness(1.2)';
                                note.classList.add('note-highlight-sync');
                                totalNotesHighlighted++;
                            }
                            
                            // Limpiar resaltado despu√©s de 500ms
                            setTimeout(() => {
                                for (let i = startIndex; i < endIndex; i++) {
                                    const note = likelyNotes[i];
                                    if (note.classList.contains('note-highlight-sync')) {
                                        note.style.fill = '';
                                        note.style.stroke = '';
                                        note.style.strokeWidth = '';
                                        note.style.filter = '';
                                        note.classList.remove('note-highlight-sync');
                                    }
                                }
                            }, 500);
                        }
                    }
                });
            }
        });
    }
    
    // Funci√≥n auxiliar para resaltar notas individuales en SVG
    function highlightCurrentNoteInSVG(currentNote) {
        clearNoteHighlights();
        
        const containers = ['osmdContainer', 'osmdContainerDynamic'];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                const svgElements = container.querySelectorAll('svg');
                svgElements.forEach(svg => {
                    const noteHeads = svg.querySelectorAll('ellipse, circle, path[d*="m"]');
                    const stems = svg.querySelectorAll('path[stroke-width]');
                    
                    const totalElements = noteHeads.length;
                    if (totalElements > 0 && currentNote && currentNote.start_time !== undefined) {
                        const noteProgress = (currentNote.start_time % 10) / 10;
                        const targetIndex = Math.floor(noteProgress * totalElements);
                        
                        const targetNoteHead = noteHeads[targetIndex];
                        if (targetNoteHead) {
                            // Aplicar resaltado consistente
                            targetNoteHead.style.fill = '#ff4444';
                            targetNoteHead.style.stroke = '#ff0000';
                            targetNoteHead.style.strokeWidth = '2px';
                            targetNoteHead.style.filter = 'drop-shadow(0 0 6px #ff4444) brightness(1.2)';
                            targetNoteHead.classList.add('note-highlight-sync');
                            
                            // Resaltar stem asociado si existe
                            const associatedStem = stems[targetIndex];
                            if (associatedStem) {
                                associatedStem.style.stroke = '#ff0000';
                                associatedStem.style.strokeWidth = '3px';
                                associatedStem.classList.add('note-highlight-sync');
                            }
                            
                            // Limpiar resaltado
                            setTimeout(() => {
                                if (targetNoteHead.classList.contains('note-highlight-sync')) {
                                    targetNoteHead.style.fill = '';
                                    targetNoteHead.style.stroke = '';
                                    targetNoteHead.style.strokeWidth = '';
                                    targetNoteHead.style.filter = '';
                                    targetNoteHead.classList.remove('note-highlight-sync');
                                }
                                
                                if (associatedStem && associatedStem.classList.contains('note-highlight-sync')) {
                                    associatedStem.style.stroke = '';
                                    associatedStem.style.strokeWidth = '';
                                    associatedStem.classList.remove('note-highlight-sync');
                                }
                            }, 500);
                        }
                    }
                });
            }
        });
    }
    
    function clearNoteHighlights() {
        // Limpiar highlights en todos los contenedores de partituras
        const containers = ['osmdContainer', 'osmdContainerDynamic', 'scoreContainer'];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                // Limpiar elementos con clase de resaltado
                const highlightedElements = container.querySelectorAll('.note-highlight-sync');
                highlightedElements.forEach(el => {
                    el.classList.remove('note-highlight-sync');
                    el.style.fill = '';
                    el.style.stroke = '';
                    el.style.strokeWidth = '';
                    el.style.filter = '';
                    el.style.opacity = '';
                });
                
                // Limpiar cursors de OSMD que puedan estar visibles
                const cursors = container.querySelectorAll('.osmdCursor, .cursor');
                cursors.forEach(cursor => {
                    cursor.style.opacity = '';
                    cursor.style.fill = '';
                    cursor.style.stroke = '';
                });
            }
        });
    }
    
    function loadScoreImage(songName, instrument) {
        const scoreContainer = document.getElementById('scoreContainer');
        
        // Mapeo de instrumentos a archivos MIDI
        const instrumentFiles = {
            'vocals': 'vocals_basic_pitch',
            'bass': 'bass_basic_pitch',
            'guitar': 'other_cluster_0_guitar',
            'piano': 'other_cluster_1_piano',
            'synth': 'other_cluster_2_synth'
        };
        
        const baseFileName = instrumentFiles[instrument];
        if (!baseFileName) {
            scoreContainer.innerHTML = '<p>‚ùå Instrumento no v√°lido</p>';
            return;
        }
        
        // Intentar cargar diferentes formatos de partitura
        const formats = ['svg', 'png', 'musicxml'];
        
        // Funci√≥n para intentar cargar un formato espec√≠fico
        function tryLoadFormat(formatIndex = 0) {
            if (formatIndex >= formats.length) {
                scoreContainer.innerHTML = `
                    <p>‚ùå No se encontraron partituras generadas para ${instrument}</p>
                    <p>üí° La partitura se generar√° autom√°ticamente en el pr√≥ximo procesamiento</p>
                    <details style="margin-top: 15px;">
                        <summary>üîß Informaci√≥n t√©cnica</summary>
                        <p>Archivos buscados:</p>
                        <ul>
                            ${formats.map(fmt => `<li>/static/stems/${songName}/htdemucs/${baseFileName}_score.${fmt}</li>`).join('')}
                        </ul>
                    </details>
                `;
                return;
            }
            
            const currentFormat = formats[formatIndex];
            const scorePath = `/static/stems/${songName}/htdemucs/${baseFileName}_score.${currentFormat}`;
            
            console.log(`Intentando cargar partitura: ${scorePath}`);
            
            if (currentFormat === 'svg') {
                // Cargar SVG directamente
                fetch(scorePath)
                    .then(response => {
                        if (response.ok) return response.text();
                        throw new Error(`HTTP ${response.status}`);
                    })
                    .then(svgContent => {
                        scoreContainer.innerHTML = `
                            <div style="text-align: center; margin: 20px 0; max-width: 100%; overflow-x: auto;">
                                ${svgContent}
                            </div>
                            <p style="color: #666; text-align: center; margin-top: 15px;">
                                ‚úÖ Partitura generada por MuseScore - Formato SVG de alta calidad
                            </p>
                        `;
                    })
                    .catch(error => {
                        console.log(`No se pudo cargar SVG: ${error.message}`);
                        tryLoadFormat(formatIndex + 1);
                    });
                    
            } else if (currentFormat === 'png') {
                // Cargar PNG como imagen
                const img = new Image();
                img.onload = function() {
                    scoreContainer.innerHTML = `
                        <div style="text-align: center; margin: 20px 0;">
                            <img src="${scorePath}" alt="Partitura de ${instrument}" 
                                 style="max-width: 100%; height: auto; border: 1px solid #ddd; 
                                        border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        </div>
                        <p style="color: #666; text-align: center; margin-top: 15px;">
                            ‚úÖ Partitura generada por MuseScore - Formato PNG
                        </p>
                    `;
                };
                img.onerror = function() {
                    console.log(`No se pudo cargar PNG: ${scorePath}`);
                    tryLoadFormat(formatIndex + 1);
                };
                img.src = scorePath;
                
            } else if (currentFormat === 'musicxml') {
                        console.log('üéØ DEBUG: Entrando en bloque MusicXML - versi√≥n actualizada v2');
        console.log(`üéØ DEBUG: scorePath = ${scorePath}`);
                // Intentar cargar el archivo MusicXML est√°tico primero para verificar si es v√°lido
                fetch(scorePath)
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    })
                    .then(xmlContent => {
                        console.log(`üìÅ MusicXML est√°tico cargado: ${xmlContent.length} caracteres`);
                        // Verificar que sea un XML v√°lido
                        if (xmlContent.trim().length > 100 && xmlContent.includes('<?xml') && xmlContent.includes('score-partwise')) {
                            console.log('‚úÖ MusicXML est√°tico v√°lido encontrado');
                            // Crear un blob para descarga
                            const blob = new Blob([xmlContent], { type: 'application/vnd.recordare.musicxml+xml' });
                            const downloadUrl = URL.createObjectURL(blob);
                            
                            scoreContainer.innerHTML = `
                                <div style="text-align: center; margin: 20px 0; padding: 30px; 
                                           border: 2px solid #28a745; border-radius: 10px; background: #f8fff9;">
                                    <h4>üéº Partitura Musical</h4>
                                    <div style="margin: 20px 0;">
                                        <button id="renderSheetMusic" class="btn" style="background: #007bff; color: white; margin-right: 10px;">
                                            üëÄ Ver Partitura
                                        </button>
                                        <a href="${downloadUrl}" download="${baseFileName}_score.musicxml" 
                                           class="btn" style="background: #28a745; color: white;">
                                            üì• Descargar MusicXML
                                        </a>
                                    </div>
                                    <div id="sheetMusicContainer" style="display: none; margin: 20px 0; padding: 20px; 
                                                                          background: white; border-radius: 10px; 
                                                                          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                                                          overflow-x: auto;">
                                        <h5>üìÑ Partitura Interactiva</h5>
                                        <div id="osmdContainer" style="min-height: 400px;"></div>
                                        <div style="margin-top: 15px; text-align: center;">
                                            <button id="hideSheetMusic" class="btn" style="background: #6c757d; color: white;">
                                                üôà Ocultar Partitura
                                            </button>
                                        </div>
                                    </div>
                                    <details style="margin-top: 15px; text-align: left;">
                                        <summary style="cursor: pointer; font-weight: bold;">üîß Ver contenido XML</summary>
                                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; 
                                                   overflow-x: auto; max-height: 300px; font-size: 12px;">
                                            ${xmlContent.substring(0, 1000)}${xmlContent.length > 1000 ? '...' : ''}
                                        </pre>
                                    </details>
                                    <p style="color: #666; font-size: 14px; margin-top: 15px;">
                                        üí° Tambi√©n puedes abrir el archivo en MuseScore, Sibelius, Finale u otro software de notaci√≥n musical
                                    </p>
                                </div>
                            `;
                            
                            // Agregar event listeners para mostrar/ocultar la partitura
                            document.getElementById('renderSheetMusic').addEventListener('click', function() {
                                renderMusicXMLSheet(xmlContent);
                            });
                            
                            document.getElementById('hideSheetMusic').addEventListener('click', function() {
                                document.getElementById('sheetMusicContainer').style.display = 'none';
                            });
                        } else {
                            console.log(`‚ö†Ô∏è MusicXML est√°tico parece inv√°lido: ${xmlContent.substring(0, 100)}`);
                            throw new Error('MusicXML est√°tico inv√°lido o corrupto');
                        }
                    })
                    .catch(error => {
                        console.log(`‚ùå No se pudo cargar MusicXML est√°tico: ${error.message}`);
                        // Si no hay archivo est√°tico v√°lido, intentar endpoint API din√°mico
                        console.log('üîÑ Intentando generar MusicXML din√°micamente...');
                        tryDynamicMusicXML();
                    });
            }
        }
        
        // Funci√≥n para intentar generar MusicXML din√°micamente
        function tryDynamicMusicXML() {
            console.log('üöÄ DEBUG: Ejecutando tryDynamicMusicXML - versi√≥n actualizada');
            const apiEndpoint = `/api/musicxml/${songName}/${instrument}`;
            console.log(`üéµ Intentando endpoint din√°mico: ${apiEndpoint}`);
            
            scoreContainer.innerHTML = `
                <div style="text-align: center; margin: 20px 0; padding: 30px; 
                           border: 2px dashed #ffa500; border-radius: 10px; background: #fff7e6;">
                    <div style="margin-bottom: 15px;">
                        <div class="loading-spinner"></div>
                    </div>
                    <h4>üéº Generando Partitura MusicXML...</h4>
                    <p>Procesando MIDI con MuseScore...</p>
                </div>
            `;
            
            fetch(apiEndpoint)
                .then(response => {
                    console.log(`üì° Respuesta del API: ${response.status} ${response.statusText}`);
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(musicxmlContent => {
                    console.log(`‚úÖ MusicXML recibido - ${musicxmlContent.length} caracteres`);
                    console.log(`üîç Inicio del XML: ${musicxmlContent.substring(0, 100)}`);
                    
                    // Crear un blob para descarga
                    const blob = new Blob([musicxmlContent], { type: 'application/vnd.recordare.musicxml+xml' });
                    const downloadUrl = URL.createObjectURL(blob);
                    
                    scoreContainer.innerHTML = `
                        <div style="text-align: center; margin: 20px 0; padding: 30px; 
                                   border: 2px solid #28a745; border-radius: 10px; background: #f8fff9;">
                            <h4>üéº Partitura Musical Generada</h4>
                            <p>La partitura ha sido generada exitosamente desde el MIDI.</p>
                            <div style="margin: 20px 0;">
                                <button id="renderSheetMusicDynamic" class="btn" style="background: #007bff; color: white; margin-right: 10px;">
                                    üëÄ Ver Partitura
                                </button>
                                <a href="${downloadUrl}" download="${baseFileName}_generated.musicxml" 
                                   class="btn" style="background: #28a745; color: white;">
                                    üì• Descargar MusicXML
                                </a>
                            </div>
                            <div id="sheetMusicContainerDynamic" style="display: none; margin: 20px 0; padding: 20px; 
                                                                          background: white; border-radius: 10px; 
                                                                          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                                                          overflow-x: auto;">
                                <h5>üìÑ Partitura Interactiva Generada</h5>
                                <div id="osmdContainerDynamic" style="min-height: 400px;"></div>
                                <div style="margin-top: 15px; text-align: center;">
                                    <button id="hideSheetMusicDynamic" class="btn" style="background: #6c757d; color: white;">
                                        üôà Ocultar Partitura
                                    </button>
                                </div>
                            </div>
                            <details style="margin-top: 15px; text-align: left;">
                                <summary style="cursor: pointer; font-weight: bold;">üîß Ver contenido XML</summary>
                                <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; 
                                           overflow-x: auto; max-height: 300px; font-size: 12px;">
                                    ${musicxmlContent.substring(0, 1000)}${musicxmlContent.length > 1000 ? '...' : ''}
                                </pre>
                            </details>
                            <p style="color: #666; font-size: 14px; margin-top: 15px;">
                                üí° Tambi√©n puedes abrir el archivo en MuseScore, Sibelius, Finale u otro software de notaci√≥n musical
                            </p>
                        </div>
                    `;
                    
                    // Agregar event listeners para la versi√≥n din√°mica
                    document.getElementById('renderSheetMusicDynamic').addEventListener('click', function() {
                        renderMusicXMLSheet(musicxmlContent, 'osmdContainerDynamic', 'sheetMusicContainerDynamic');
                    });
                    
                    document.getElementById('hideSheetMusicDynamic').addEventListener('click', function() {
                        document.getElementById('sheetMusicContainerDynamic').style.display = 'none';
                    });
                })
                .catch(error => {
                    console.error(`‚ùå Error generando MusicXML din√°mico: ${error.message}`);
                    scoreContainer.innerHTML = `
                        <div style="text-align: center; margin: 20px 0; padding: 30px; 
                                   border: 2px solid #dc3545; border-radius: 10px; background: #fff5f5;">
                            <h4>‚ùå No se pudo generar la partitura</h4>
                            <p>Error: ${error.message}</p>
                            <details style="margin-top: 15px;">
                                <summary>üîß Informaci√≥n de depuraci√≥n</summary>
                                <p><strong>Endpoint intentado:</strong> ${apiEndpoint}</p>
                                <p><strong>Instrumento:</strong> ${instrument}</p>
                                <p><strong>Archivo base:</strong> ${baseFileName}</p>
                                <p>Revisa la consola del navegador y los logs del servidor para m√°s detalles.</p>
                            </details>
                        </div>
                    `;
                    
                    // Mostrar mensaje final de fallo despu√©s de 3 segundos
                    setTimeout(() => {
                        scoreContainer.innerHTML = `
                            <div style="text-align: center; margin: 20px 0; padding: 30px; 
                                       border: 2px dashed #ccc; border-radius: 10px; background: #f9f9f9;">
                                <h4>‚ùå No se encontraron partituras</h4>
                                <p>No se pudieron cargar partituras en ning√∫n formato disponible.</p>
                                <p>üí° Vuelve a procesar el audio para generar partituras autom√°ticamente.</p>
                            </div>
                        `;
                    }, 3000);
                });
        }
        
        // Empezar a intentar cargar formatos
        tryLoadFormat(0);
    }
    
    // Variables globales para almacenar la instancia de OSMD y datos de sincronizaci√≥n
    let currentOSMD = null;
    let currentNotesData = null;
    let syncInterval = null;
    let globalAudioPlayer = null; // Referencia al reproductor de audio para sincronizaci√≥n
    
    // Funci√≥n para renderizar MusicXML usando OpenSheetMusicDisplay
    function renderMusicXMLSheet(musicxmlContent, containerId = 'osmdContainer', parentContainerId = 'sheetMusicContainer') {
        console.log('üéº Iniciando renderizado de partitura...');
        
        try {
            // Mostrar el contenedor
            document.getElementById(parentContainerId).style.display = 'block';
            
            // Limpiar el contenedor anterior
            const container = document.getElementById(containerId);
            container.innerHTML = '<p>üîÑ Cargando partitura...</p>';
            
            // Crear instancia de OpenSheetMusicDisplay
            const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(containerId, {
                // Configuraci√≥n para mejor visualizaci√≥n
                autoResize: true,
                backend: 'svg',
                drawTitle: false,
                drawComposer: false,
                drawLyricist: false,
                drawPartNames: true,
                drawPartAbbreviations: false,
                fillEmptyMeasuresWithWholeRest: false,
                setWantedStemDirectionByXml: true,
                coloringMode: 0,
                defaultColorNotehead: '#000000',
                defaultColorStem: '#000000',
                autoGenerateMultipleRestMeasuresFromRestMeasures: false
            });
            
            console.log('üìÑ OpenSheetMusicDisplay inicializado, cargando XML...');
            
            // Cargar el MusicXML
            osmd.load(musicxmlContent).then(() => {
                console.log('‚úÖ MusicXML cargado, renderizando...');
                
                // Renderizar la partitura
                osmd.render();
                
                // Guardar la instancia para sincronizaci√≥n
                currentOSMD = osmd;
                
                console.log('üéº Partitura renderizada exitosamente!');
                console.log('üéµ Sincronizaci√≥n con audio habilitada');
                
                // Extraer tabla de tiempos de notas inmediatamente despu√©s de renderizar
                setTimeout(() => {
                    extractNoteTimingsFromOSMD();
                }, 500); // Dar tiempo para que OSMD termine de renderizar
                
                // Verificar si ya existe el checkbox de sincronizaci√≥n global
                if (!document.getElementById('enableSync')) {
                    // Crear checkbox global en el √°rea de controles de audio
                    const audioControls = document.querySelector('.audio-controls') || document.body;
                    const syncControls = document.createElement('div');
                    syncControls.id = 'syncControls';
                    syncControls.style.cssText = `
                        text-align: center; 
                        margin: 15px 0; 
                        padding: 10px; 
                        background: #e3f2fd; 
                        border-radius: 8px; 
                        border: 2px solid #2196f3;
                    `;
                    syncControls.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            <label style="margin-right: 15px; font-weight: bold;">
                                <input type="checkbox" id="enableSync" checked> 
                                üéØ Sincronizar partitura con audio
                            </label>
                            <button id="resetHighlight" class="btn" style="background: #ffc107; color: black; padding: 5px 15px; font-size: 12px;">
                                üîÑ Reiniciar resaltado
                            </button>
                        </div>
                        <small style="color: #666;">
                            üéµ La sincronizaci√≥n resalta autom√°ticamente las notas durante la reproducci√≥n
                        </small>
                    `;
                    
                    // Insertar antes del contenedor de partitura
                    const scoreContainer = document.getElementById('scoreContainer');
                    if (scoreContainer && scoreContainer.parentNode) {
                        scoreContainer.parentNode.insertBefore(syncControls, scoreContainer);
                    } else {
                        document.body.appendChild(syncControls);
                    }
                    
                    console.log('üéØ [SYNC DEBUG] Checkbox de sincronizaci√≥n global creado');
                }
                
                // Agregar informaci√≥n adicional local
                container.insertAdjacentHTML('beforeend', `
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <small style="color: #666;">
                            ‚ú® Partitura renderizada con OpenSheetMusicDisplay
                            <br/>üìè Mostrando partitura completa
                            <br/>üéØ Usa los controles de sincronizaci√≥n arriba para habilitar/deshabilitar
                        </small>
                    </div>
                `);
                
                // Agregar event listeners para los controles de sincronizaci√≥n (solo si no existen)
                const resetButton = document.getElementById('resetHighlight');
                if (resetButton && !resetButton.hasAttribute('data-listener-added')) {
                    resetButton.addEventListener('click', function() {
                        if (currentOSMD) {
                            currentOSMD.cursor.reset();
                            currentOSMD.render();
                            console.log('üîÑ Resaltado reiniciado');
                        }
                    });
                    resetButton.setAttribute('data-listener-added', 'true');
                    console.log('üéØ [SYNC DEBUG] Event listener para resetHighlight agregado');
                }
                
            }).catch(error => {
                console.error('‚ùå Error al cargar MusicXML:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #d32f2f;">
                        <h5>‚ùå Error al cargar la partitura</h5>
                        <p>No se pudo renderizar el archivo MusicXML:</p>
                        <pre style="color: #666; font-size: 12px;">${error.message}</pre>
                        <p><small>üí° Intenta descargar el archivo y abrirlo en MuseScore</small></p>
                    </div>
                `;
            });
            
        } catch (error) {
            console.error('‚ùå Error general en renderMusicXMLSheet:', error);
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #d32f2f;">
                    <h5>‚ùå Error de renderizado</h5>
                    <p>Error inesperado al inicializar el visor de partituras:</p>
                    <pre style="color: #666; font-size: 12px;">${error.message}</pre>
                </div>
            `;
        }
    }
    
    // Funci√≥n obsoleta mantenida para compatibilidad
    function renderScore(notesData) {
        // Redirigir a la nueva funci√≥n de carga de im√°genes
        loadScoreImage('{{ song_name }}', '{{ instrument }}');
        }
</script>
{% endblock %} 