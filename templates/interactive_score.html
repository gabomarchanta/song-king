{% extends "layout.html" %}

{% block title %}Partitura Interactiva - {{ song_name }} - {{ instrument }}{% endblock %}

{% block head %}
<script src="/static/js/vexflow.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        overflow: hidden;
    }
    .header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        text-align: center;
    }
    .score-container {
        padding: 30px;
        background: #f8f9fa;
    }
    .controls {
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        margin: 0 8px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .progress-container {
        margin: 20px 0;
        padding: 0 20px;
    }
    .progress {
        width: 100%;
        height: 25px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(45deg, #28a745, #20c997);
        width: 0%;
        transition: width 0.1s ease;
        border-radius: 15px;
    }
    .time-display {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin: 15px 0;
        text-align: center;
    }
    .note-info {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .note-highlight {
        fill: #ff6b6b !important;
        stroke: #ff4757 !important;
        stroke-width: 3 !important;
        filter: drop-shadow(0 0 5px rgba(255, 107, 107, 0.5));
    }
    .score-display {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-height: 200px;
    }
    .back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255,255,255,0.9);
        color: #333;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<button class="back-btn" onclick="window.history.back()">‚Üê Volver</button>

<div class="container">
    <div class="header">
        <h1>üéº {{ song_name }}</h1>
        <h2>Instrumento: {{ instrument.title() }}</h2>
    </div>
    
    <div class="score-container">
        <div class="controls">
            <button class="btn" id="playBtn">‚ñ∂Ô∏è Reproducir</button>
            <button class="btn" id="pauseBtn" disabled>‚è∏Ô∏è Pausar</button>
            <button class="btn" id="stopBtn" disabled>‚èπÔ∏è Detener</button>
            <button class="btn" id="resetBtn">üîÑ Reiniciar</button>
        </div>
        
        <div class="progress-container">
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="time-display" id="timeDisplay">Tiempo: 0:00 / 0:00</div>
        </div>
        
        <div class="note-info" id="noteInfo">
            <h3>üìù Informaci√≥n de la partitura</h3>
            <p>Cargando datos...</p>
        </div>
        
        <div class="score-display" id="score"></div>
    </div>
</div>

<script>
    window.onload = function() {
        // Cargar datos de la partitura
        fetch('/api/score/{{ song_name }}/{{ instrument }}/render')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('noteInfo').innerHTML = 
                        '<h3>‚ùå Error</h3><p>' + data.error + '</p>';
                    return;
                }
                
                const notesData = data.notes;
                const totalDuration = data.total_duration;
                
                // Mostrar informaci√≥n
                document.getElementById('noteInfo').innerHTML = `
                    <h3>üìù Informaci√≥n de la partitura</h3>
                    <p><strong>Total de notas:</strong> ${notesData.length}</p>
                    <p><strong>Duraci√≥n total:</strong> ${formatTime(totalDuration)}</p>
                    <p><strong>Instrumento:</strong> {{ instrument.title() }}</p>
                `;
                
                // Inicializar controles de reproducci√≥n
                initPlaybackControls(notesData, totalDuration);
                
                // Renderizar partitura visual
                renderScore(notesData);
            })
            .catch(error => {
                console.error('Error cargando datos:', error);
                document.getElementById('noteInfo').innerHTML = 
                    '<h3>‚ùå Error</h3><p>Error al cargar los datos de la partitura</p>';
            });
    };
    
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    function initPlaybackControls(notesData, totalDuration) {
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');
        
        let currentTime = 0;
        let isPlaying = false;
        let playbackInterval;
        
        playBtn.addEventListener('click', () => {
            if (!isPlaying) {
                isPlaying = true;
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                
                playbackInterval = setInterval(() => {
                    currentTime += 0.1;
                    const progress = (currentTime / totalDuration) * 100;
                    progressBar.style.width = `${Math.min(progress, 100)}%`;
                    timeDisplay.textContent = `Tiempo: ${formatTime(currentTime)} / ${formatTime(totalDuration)}`;
                    
                    // Resaltar nota actual
                    highlightCurrentNote(currentTime, notesData);
                    
                    if (currentTime >= totalDuration) {
                        stopPlayback();
                    }
                }, 100);
            }
        });
        
        pauseBtn.addEventListener('click', () => {
            if (isPlaying) {
                isPlaying = false;
                playBtn.disabled = false;
                pauseBtn.disabled = true;
                clearInterval(playbackInterval);
            }
        });
        
        stopBtn.addEventListener('click', stopPlayback);
        
        resetBtn.addEventListener('click', () => {
            stopPlayback();
            currentTime = 0;
            progressBar.style.width = '0%';
            timeDisplay.textContent = `Tiempo: 0:00 / ${formatTime(totalDuration)}`;
            clearNoteHighlights();
        });
        
        function stopPlayback() {
            isPlaying = false;
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            clearInterval(playbackInterval);
        }
    }
    
    function highlightCurrentNote(currentTime, notesData) {
        // Limpiar highlights anteriores
        clearNoteHighlights();
        
        // Encontrar nota actual
        const currentNote = notesData.find(note => 
            currentTime >= note.start_time && currentTime <= note.end_time
        );
        
        if (currentNote) {
            // Resaltar nota en la partitura visual
            const noteElements = document.querySelectorAll(`[data-note="${currentNote.note}"]`);
            noteElements.forEach(el => el.classList.add('note-highlight'));
        }
    }
    
    function clearNoteHighlights() {
        document.querySelectorAll('.note-highlight').forEach(el => {
            el.classList.remove('note-highlight');
        });
    }
    
    function renderScore(notesData) {
        const scoreDiv = document.getElementById('score');
        
        // Usar VexFlow para renderizar la partitura
        const { Factory, EasyScore, System } = Vex.Flow;
        
        // Crear canvas
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 200;
        scoreDiv.appendChild(canvas);
        
        const factory = new Factory({
            renderer: { elementId: canvas, width: 800, height: 200 }
        });
        
        const score = factory.EasyScore();
        const system = factory.System();
        
        // Convertir notas a formato VexFlow
        const vexNotes = notesData.slice(0, 16).map(note => {
            const noteName = note.note.split('/')[0];
            const octave = parseInt(note.note.split('/')[1]);
            return `${noteName}/${octave}/${note.duration}`;
        });
        
        if (vexNotes.length > 0) {
            system.addStave({
                voices: [score.voice(score.notes(vexNotes.join(', ')))]
            });
            
            factory.draw();
        } else {
            scoreDiv.innerHTML = '<p>No se pudieron renderizar las notas</p>';
        }
    }
</script>
{% endblock %} 